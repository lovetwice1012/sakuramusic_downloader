<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakuramusic V2 Music Downloader</title>
</head>

<body>
    <h1>Sakuramusic V2 Music Downloader</h1>
    <p style="color: red;">This is a test version.</p>
    <p>Supported formats: OPUS, MP3, MP4</p>
    <p>Supported sites: YouTube</p>
    <h3 id="status" style="color: green;">Status: Ready</h3>
    <form id="downloadForm" action="/api/download" method="post">
        <label for="url">URL:</label><br>
        <input type="text" id="url" name="url" required><br>
        <input type="radio" id="format" name="format" value="opus" checked>
        <label for="format">OPUS</label><br>
        <input type="radio" id="format" name="format" value="mp3">
        <label for="format">MP3</label><br>
        <input type="radio" id="format" name="format" value="mp4">
        <label for="format">MP4</label><br>
        <input type="checkbox" id="directdownload" name="directdownload">
        <label for="directdownload">Direct Download</label><br>
        <button id="submit" type="submit">Download</button>
    </form>
    <div id="musicinfo" style="display: none;">
        <p id="title"></p>
        <p id="url"></p>
        <p id="totalsec"></p>
        <p id="viewcount"></p>
        <p id="author"></p>
        <p><a id="authorurl" href=""></a></p>
        <p id="subscriber_count"></p>
        <p id="verified"></p>
        <p>Thumbnail:</p>
        <img id="thumbnail" src="" alt="">
        <p><a id="resultURL" href="">If you want Share this results to anyone, use this link.</a></p>
    </div>
    <audio id="audioPlayer" controls style="display:none;"></audio>
    <video id="videoPlayer" controls style="display:none;"></video>

    <script>
        let ios = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;;
        window.onload = function () {
            if (ios) {
                const directdownload = document.getElementById("directdownload");
                directdownload.checked = true;
                directdownload.disabled = true;
            }

            //check if url parameter exists
            const url = new URL(window.location.href);
            const urlParams = url.searchParams;
            const urlParamUrl = urlParams.get("url");
            const urlParamFormat = urlParams.get("format");
            if (urlParamFormat) {
                document.querySelector('input[name="format"][value="' + urlParamFormat + '"]').checked = true;
            }

            //check browser is support opus
            const audio = new Audio();
            if (audio.canPlayType("audio/ogg; codecs=opus") === "") {
                const opus = document.querySelector('input[name="format"][value="opus"]');
                opus.disabled = true;
                if (opus.checked) {
                    document.querySelector('input[name="format"][value="mp3"]').checked = true;
                }
            }

            //check browser is support mp3
            if (audio.canPlayType("audio/mpeg") === "") {
                const mp3 = document.querySelector('input[name="format"][value="mp3"]');
                mp3.disabled = true;
                if (mp3.checked) {
                    document.querySelector('input[name="format"][value="mp4"]').checked = true;
                }
            }

            //check browser is support mp4
            if (audio.canPlayType("video/mp4") === "") {
                const mp4 = document.querySelector('input[name="format"][value="mp4"]');
                mp4.disabled = true;
                if (mp4.checked) {
                    document.querySelector('input[name="format"][value="mp3"]').checked = true;
                }
            }

            //if all formats are disabled
            if (document.querySelectorAll('input[name="format"]:disabled').length === document.querySelectorAll('input[name="format"]').length) {
                document.getElementById("status").textContent = "Status: Your browser does not support any formats.";
                document.getElementById("status").style.color = "red";
                document.getElementById("submit").disabled = true;
            }

            //if url parameter exists, download
            if (urlParamUrl) {
                document.getElementById("url").value = urlParamUrl;
                document.getElementById("submit").click();
            }

        }

        function showMusicInfo(response_videodata) {
            const musicinfo = document.getElementById("musicinfo");
            musicinfo.style.display = "block";
            document.getElementById("title").textContent = "Title: " + response_videodata.title;
            document.getElementById("url").textContent = "URL: " + response_videodata.url;
            document.getElementById("totalsec").textContent = "TotalSec: " + response_videodata.totalsec;
            document.getElementById("viewcount").textContent = "ViewCount: " + response_videodata.viewcount;
            document.getElementById("author").textContent = "Author: " + response_videodata.author.name;
            document.getElementById("authorurl").setAttribute("href", response_videodata.author.url);
            document.getElementById("authorurl").textContent = "Author URL: " + response_videodata.author.url;
            document.getElementById("subscriber_count").textContent = "SubscriberCount: " + response_videodata.author.subscriber_count;
            document.getElementById("verified").textContent = "Verified: " + response_videodata.author.verified;
            document.getElementById("thumbnail").src = response_videodata.thumbnail;
        }

        function responseCheckAndReturnJson(response, statusMessage = "Status: Failed to get video data.", statusColor = "red") {
            if (!response.ok) {
                document.getElementById("status").textContent = statusMessage;
                document.getElementById("status").style.color = statusColor;
                document.getElementById("submit").disabled = false;
                throw new Error('Network response was not ok');
            }
            return response.json();
        }

        function responseCheckAndReturnBlob(response, statusMessage = "Status: Failed to download.", statusColor = "red") {
            if (!response.ok) {
                document.getElementById("status").textContent = statusMessage;
                document.getElementById("status").style.color = statusColor;
                document.getElementById("submit").disabled = false;
                throw new Error('Network response was not ok');
            }
            return response.blob();
        }

        document.getElementById("downloadForm").addEventListener("submit", function (event) {
            event.preventDefault();

            const submit = document.getElementById("submit");
            submit.disabled = true;

            const resultURL = document.getElementById("resultURL");
            const uri = new URL(window.location.href);
            resultURL.href = uri.origin + uri.pathname + "?url=" + encodeURIComponent(document.getElementById("url").value) + "&format=" + document.querySelector('input[name="format"]:checked').value;

            const directdownload = document.getElementById("directdownload");
            if (directdownload.checked) {
                const url = document.getElementById("url").value;
                const format = document.querySelector('input[name="format"]:checked').value;
                //get music data
                fetch("/api/getInfo?url=" + encodeURIComponent(url), {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "Accept": "application/json"
                    },
                })
                    .then(response_videodata => {
                        return responseCheckAndReturnJson(response_videodata);
                    })
                    .then(response_videodata => {
                        const link = document.createElement('a')
                        switch (format) {
                            case "opus":
                                link.download = response_videodata.title + ".opus"
                                link.href = "/api/download/audio/opus?url=" + encodeURIComponent(url)
                                break;
                            case "mp3":
                                link.download = response_videodata.title + ".mp3"
                                link.href = "/api/download/audio/mp3?url=" + encodeURIComponent(url)
                                break;
                            case "mp4":
                                link.download = response_videodata.title + ".mp4"
                                link.href = "/api/download/video?url=" + encodeURIComponent(url)
                                break;
                        }
                        link.click()
                        submit.disabled = false;
                    })
                    .catch(error => {
                        submit.disabled = false;
                        console.error('There has been a problem with your fetch operation:', error);
                    });
                submit.disabled = false;
                return;
            }

            const status = document.getElementById("status");
            status.textContent = "Downloading...";
            status.style.color = "aqua";

            const url = document.getElementById("url").value;
            const format = document.querySelector('input[name="format"]:checked').value;
            fetch("/api/getInfo?url=" + encodeURIComponent(url), {
                method: "GET",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "Accept": "application/json"
                },
            })
                .then(response_videodata => {
                    return responseCheckAndReturnJson(response_videodata);
                })
                .then(response_videodata => {
                    switch (format) {
                        case "opus":
                            fetch("/api/download/audio/opus?url=" + encodeURIComponent(url), {
                                method: "GET",
                                headers: {
                                    "Content-Type": "application/x-www-form-urlencoded"
                                },
                            })
                                .then(response => {
                                    return responseCheckAndReturnBlob(response);
                                })
                                .then(blob => {
                                    const url = window.URL.createObjectURL(blob);
                                    const audioPlayer = document.getElementById("audioPlayer");
                                    audioPlayer.src = url;
                                    audioPlayer.style.display = "block";
                                    const videoPlayer = document.getElementById("videoPlayer");
                                    videoPlayer.style.display = "none";
                                    if (videoPlayer.src) {
                                        videoPlayer.src = "";
                                    }
                                    audioPlayer.title = response_videodata.title + ".opus";
                                    showMusicInfo(response_videodata);
                                    status.textContent = "Status: SUCCESS!!";
                                    status.style.color = "green";
                                    submit.disabled = false;
                                    audioPlayer.play();
                                })
                                .catch(error => {
                                    status.textContent = "Status: Failed to download.";
                                    status.style.color = "red";
                                    submit.disabled = false;
                                    console.error('There has been a problem with your fetch operation:', error);
                                });
                            break;
                        case "mp3":
                            fetch("/api/download/audio/mp3?url=" + encodeURIComponent(url), {
                                method: "GET",
                                headers: {
                                    "Content-Type": "application/x-www-form-urlencoded"
                                },
                            })
                                .then(response => {
                                    return responseCheckAndReturnBlob(response);
                                })
                                .then(blob => {
                                    const url = window.URL.createObjectURL(blob);
                                    const audioPlayer = document.getElementById("audioPlayer");
                                    audioPlayer.src = url;
                                    audioPlayer.style.display = "block";
                                    const videoPlayer = document.getElementById("videoPlayer");
                                    videoPlayer.style.display = "none";
                                    if (videoPlayer.src) {
                                        videoPlayer.src = "";
                                    }
                                    audioPlayer.title = response_videodata.title + ".mp3";
                                    showMusicInfo(response_videodata);
                                    status.textContent = "Status: SUCCESS!!";
                                    status.style.color = "green";
                                    submit.disabled = false;
                                    audioPlayer.play();
                                })
                                .catch(error => {
                                    status.textContent = "Status: Failed to download.";
                                    status.style.color = "red";
                                    submit.disabled = false;
                                    console.error('There has been a problem with your fetch operation:', error);
                                });
                            break;
                        case "mp4":
                            fetch("/api/download/video?url=" + encodeURIComponent(url), {
                                method: "GET",
                                headers: {
                                    "Content-Type": "application/x-www-form-urlencoded"
                                },
                            })
                                .then(response => {
                                    return responseCheckAndReturnBlob(response, "Status: Failed to download video.");
                                })
                                .then(blob => {
                                    // BlobオブジェクトをURLに変換して、オーディオ要素にセット
                                    const url = window.URL.createObjectURL(blob);
                                    const videoPlayer = document.getElementById("videoPlayer");
                                    videoPlayer.src = url;
                                    videoPlayer.style.display = "block";
                                    const audioPlayer = document.getElementById("audioPlayer");
                                    audioPlayer.style.display = "none";
                                    if (audioPlayer.src) {
                                        audioPlayer.src = "";
                                    }
                                    videoPlayer.title = response_videodata.title + ".mp4";
                                    showMusicInfo(response_videodata);
                                    status.textContent = "Status: SUCCESS!!";
                                    status.style.color = "green";
                                    submit.disabled = false;
                                    videoPlayer.play();
                                })
                                .catch(error => {
                                    status.textContent = "Status: Failed to download.";
                                    status.style.color = "red";
                                    submit.disabled = false;
                                    console.error('There has been a problem with your fetch operation:', error);
                                });
                            break;
                    }
                }).catch(error => {
                    status.textContent = "Status: Failed to get video data.";
                    status.style.color = "red";
                    submit.disabled = false;
                    console.error('There has been a problem with your fetch operation:', error);
                });
        });
    </script>
</body>

</html>